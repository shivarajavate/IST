class Board{constructor(){this.layer,this.x,this.y,this.w,this.h,this.uiSettings,this.konvaRect,this.konvaText,this.note=null,this.isVisible=!1}init(e,t,i,s,o,n,a,l){this.layer=e,this.x=t+n,this.y=i+a,this.w=s-2*n,this.h=o-2*a,this.uiSettings={styles:l.styles.board,properties:l.properties.board,getConfig:l.getConfig.board};var h={x:this.x,y:this.y,width:this.w,height:this.h},r=this.uiSettings.getConfig(h,"konvaRect");this.konvaRect=new Konva.Rect(r);h={x:this.x,y:this.y,width:this.w,height:this.h},r=this.uiSettings.getConfig(h,"konvaText");this.konvaText=new Konva.Text(r),this.layer.add(this.konvaRect),this.layer.add(this.konvaText)}attachNote(e){this.note=e,this.konvaText.text(this.note.name)}unattachNote(){this.note=null,this.konvaText.text("")}unhighlightNote(){var e=this.uiSettings.getConfig({},"konvaRect");this.konvaRect.fill(e.fill),this.konvaRect.stroke(e.stroke),this.layer.batchDraw()}highlightNote(){var e=this.uiSettings.getConfig({},"selectedKonvaRect");this.konvaRect.fill(e.fill),this.konvaRect.stroke(e.stroke),this.layer.batchDraw()}applyTheme(e){this.uiSettings.styles=e.board,this.konvaRect.fill(this.uiSettings.styles.konvaRect.fill),this.konvaRect.stroke(this.uiSettings.styles.konvaRect.stroke),this.layer.batchDraw()}makeVisible(e){this.konvaRect.visible(e),this.konvaText.visible(e),this.isVisible=e,this.layer.batchDraw()}}class ConditionsTable{constructor(){this.accordianId,this.errorMessage,this.selectedIndex,this.bcList,this.options,this.bc}init(e){this.accordianId=e,this.errorMessage="",this.selectedIndex=-1,this.bcList=[],this.options={space:"",openSquareBracket:"[",closeSquareBracket:"]",openRoundBracket:"(",closeRoundBracket:")",comma:","},this.appService=angular.element(document.body).injector().get("AppService");var t=document.getElementById(this.accordianId).value;if(t){var i=t.replace(/(?:\r\n|\r|\n)/g,"").match(new RegExp("@start(.*)@end"));i&&(this.bcList=this.appService.stringToJson(i,this.options))}this.addCondition()}openConditionsTable(){$("#conditionsTableModal").modal("show")}closeConditionsTable(){$("#conditionsTableModal").modal("hide")}addCondition(){this.bc={name:"",value:{positive:[],negative:[]}},this.bcList.push(this.bc)}removeCondition(){this.bcList.splice(this.selectedIndex,1),0===this.bcList.length&&this.addCondition(),this.selectedIndex=-1}selectCondition(e){this.selectedIndex=this.selectedIndex===e?-1:e}saveConditions(){var e=this,t="";e.errorMessage="";var i=e.bcList.map(function(e){return e.name});if(i.some(function(e,t){if(""!=e)return i.indexOf(e)!=t}))e.errorMessage=this.appService.getResourceText("R009");else if(e.bcList.length>0&&""!=e.bcList[0].name){t="@start\n",e.bcList.forEach(function(i){""==i.name?e.bcList.splice(e.bcList.indexOf(i),1):(t+=i.name+"[(",t+=i.value.positive+")(",t+=i.value.negative+")];\n",e.closeConditionsTable())}),t+="@end";var s=document.getElementById(e.accordianId).value.match(new RegExp(/@start(.|\s)*@end/));s?document.getElementById(e.accordianId).value=document.getElementById(e.accordianId).value.replace(s[0],t):(t=t?t+"\n":t,document.getElementById(e.accordianId).value=t+document.getElementById(e.accordianId).value)}}}class LevelBoardView{constructor(){this.layer,this.x,this.y,this.w,this.h,this.uiSettings,this.sectionW,this.sectionH,this.boardViewRect,this.sectionCollection=[],this.noOfSections=0,this.noOfSectionAreas=0,this.isVisible=!1}init(e,t,i,s,o,n,a,l,h,r){this.layer=e,this.x=t,this.y=i,this.w=s,this.h=o,this.uiSettings={styles:h.styles.level,properties:h.properties.level,getConfig:h.getConfig.level};var c=this.w*(this.uiSettings.properties.boardViewRect.wPct/100),d=this.h*(this.uiSettings.properties.boardViewRect.hPct/100);this.sectionW=c*(r.wPct/100),this.sectionH=d*(r.hPct/100),this.noOfSections=l.length,this.noOfSectionAreas=r.noOfSectionAreas;var u={x:this.x,y:this.y,width:this.w*(this.uiSettings.properties.boardViewRect.wPct/100),height:this.h*(this.uiSettings.properties.boardViewRect.hPct/100)},g=this.uiSettings.getConfig(u,"boardViewRect");this.boardViewRect=new Konva.Rect(g),this.layer.add(this.boardViewRect);var m=0;"RECON"===n&&this.noOfSectionAreas>this.noOfSections&&(m=this.noOfSectionAreas-this.noOfSections);for(var p=0;p<this.noOfSections;++p){t=this.x+(m+p)*this.sectionW,i=this.y,s=this.sectionW,o=this.sectionH;var v=r.margin;this.sectionCollection[p]=new Section,this.sectionCollection[p].init(e,t,i,s,o,v,n,a,l[p],h,!1)}}displaySectionAtStart(){var e=this;e.sectionCollection.forEach(function(t){var i=t.view.x+e.sectionW,s=t.view.y;t.view.relocateAt(i,s)})}displaySectionAtEnd(){var e=this;e.sectionCollection.forEach(function(t){var i=t.view.x-e.sectionW,s=t.view.y;t.view.relocateAt(i,s)})}slideSectionsToRight(){var e=this,t=0;new Konva.Animation(function(){20!==t?(e.sectionCollection.forEach(function(t){var i=t.view.x+e.sectionW/20,s=t.view.y;t.view.relocateAt(i,s)}),++t):this.stop()}).start()}slideSectionsToLeft(){var e=this,t=0;new Konva.Animation(function(){20!==t?(e.sectionCollection.forEach(function(t){var i=t.view.x-e.sectionW/20,s=t.view.y;t.view.relocateAt(i,s)}),++t):this.stop()}).start()}applyTheme(e){this.uiSettings.styles=e.level,this.boardViewRect.fill(this.uiSettings.styles.boardViewRect.fill),this.boardViewRect.stroke(this.uiSettings.styles.boardViewRect.stroke),this.sectionCollection.forEach(function(t){t.view.applyTheme(e)}),this.layer.batchDraw()}makeVisible(e){this.boardViewRect.visible(e);for(var t=0;t<this.noOfSections;++t)this.sectionCollection[t].view.makeVisible(e);this.layer.batchDraw(),this.isVisible=e}}class LevelController{constructor(){this.startSectionID=-1,this.endSectionID=-1,this.model,this.view}init(e,t){this.model=e,this.view=t,this.view.boardView.noOfSectionAreas<this.view.boardView.noOfSections&&(this.startSectionID=0,this.endSectionID=this.startSectionID+(this.view.boardView.noOfSectionAreas-1)),this.alterScrollbar()}scrollLeft(){this.view.boardView.noOfSectionAreas<this.view.boardView.noOfSections&&this.startSectionID>0&&(--this.startSectionID,this.view.boardView.slideSectionsToRight(),this.endSectionID=this.startSectionID+(this.view.boardView.noOfSectionAreas-1))}scrollRight(){this.view.boardView.noOfSectionAreas<this.view.boardView.noOfSections&&this.endSectionID<this.view.boardView.noOfSections-1&&(++this.endSectionID,this.view.boardView.slideSectionsToLeft(),this.startSectionID=this.endSectionID-(this.view.boardView.noOfSectionAreas-1))}alterScrollbar(){var e=this.view.boardView.noOfSections>this.view.boardView.noOfSectionAreas;this.view.headerView.makeScrollbarVisible(e)}}class LevelHeaderView{constructor(){this.layer,this.x,this.y,this.w,this.h,this.uiSettings,this.scrollLeftButtonRect,this.scrollLeftButtonText,this.scrollRightButtonRect,this.scrollRightButtonText,this.levelIDRect,this.levelIDText,this.levelNameRect,this.levelNameText,this.isVisible=!1,this.isScrollable=!1}init(e,t,i,s,o,n,a,l,h){switch(this.layer=e,this.x=t,this.y=i,this.w=s,this.h=o,this.uiSettings={styles:h.styles.level,properties:h.properties.level,getConfig:h.getConfig.level},n){case"RECON":var r={x:this.x,y:this.y,width:this.w*(this.uiSettings.properties.scrollLeftButtonRect.wPct/100),height:this.h*(this.uiSettings.properties.scrollLeftButtonRect.hPct/100)},c=this.uiSettings.getConfig(r,"scrollLeftButtonRect");this.scrollLeftButtonRect=new Konva.Rect(c);r={x:this.x,y:this.y,width:this.w*(this.uiSettings.properties.scrollLeftButtonText.wPct/100),height:this.h*(this.uiSettings.properties.scrollLeftButtonText.hPct/100)},c=this.uiSettings.getConfig(r,"scrollLeftButtonText");this.scrollLeftButtonText=new Konva.Text(c),this.layer.add(this.scrollLeftButtonRect),this.layer.add(this.scrollLeftButtonText);r={x:this.x,y:this.y+this.h*(this.uiSettings.properties.scrollLeftButtonRect.hPct/100),width:this.w*(this.uiSettings.properties.scrollRightButtonRect.wPct/100),height:this.h*(this.uiSettings.properties.scrollRightButtonRect.hPct/100)},c=this.uiSettings.getConfig(r,"scrollRightButtonRect");this.scrollRightButtonRect=new Konva.Rect(c);r={x:this.x,y:this.y+this.h*(this.uiSettings.properties.scrollLeftButtonRect.hPct/100),width:this.w*(this.uiSettings.properties.scrollRightButtonText.wPct/100),height:this.h*(this.uiSettings.properties.scrollRightButtonText.hPct/100)},c=this.uiSettings.getConfig(r,"scrollRightButtonText");this.scrollRightButtonText=new Konva.Text(c),this.layer.add(this.scrollRightButtonRect),this.layer.add(this.scrollRightButtonText);r={x:this.x+this.w*(this.uiSettings.properties.scrollLeftButtonRect.wPct/100),y:this.y,width:this.w*(this.uiSettings.properties.levelIDRect.wPct/100),height:this.h*(this.uiSettings.properties.levelIDRect.hPct/100)},c=this.uiSettings.getConfig(r,"levelIDRect");this.levelIDRect=new Konva.Rect(c);r={x:this.x+this.w*(this.uiSettings.properties.scrollLeftButtonRect.wPct/100),y:this.y,width:this.w*(this.uiSettings.properties.levelIDText.wPct/100),height:this.h*(this.uiSettings.properties.levelIDText.hPct/100),text:a},c=this.uiSettings.getConfig(r,"levelIDText");this.levelIDText=new Konva.Text(c),this.layer.add(this.levelIDRect),this.layer.add(this.levelIDText);r={x:this.x+this.w*(this.uiSettings.properties.scrollLeftButtonRect.wPct/100),y:this.y+this.h*(this.uiSettings.properties.levelIDRect.hPct/100),width:this.w*(this.uiSettings.properties.levelNameRect.wPct/100),height:this.h*(this.uiSettings.properties.levelNameRect.hPct/100)},c=this.uiSettings.getConfig(r,"levelNameRect");this.levelNameRect=new Konva.Rect(c);r={x:this.x+this.w*(this.uiSettings.properties.scrollLeftButtonRect.wPct/100),y:this.y+this.h*(this.uiSettings.properties.levelIDRect.hPct/100),width:this.w*(this.uiSettings.properties.levelNameText.wPct/100),height:this.h*(this.uiSettings.properties.levelNameText.hPct/100),text:l},c=this.uiSettings.getConfig(r,"levelNameText");this.levelNameText=new Konva.Text(c),this.layer.add(this.levelNameRect),this.layer.add(this.levelNameText);break;case"SEARCH":r={x:this.x,y:this.y,width:this.w*(this.uiSettings.properties.levelIDRect.wPct/100),height:this.h*(this.uiSettings.properties.levelIDRect.hPct/100)},c=this.uiSettings.getConfig(r,"levelIDRect");this.levelIDRect=new Konva.Rect(c);r={x:this.x,y:this.y,width:this.w*(this.uiSettings.properties.levelIDText.wPct/100),height:this.h*(this.uiSettings.properties.levelIDText.hPct/100),text:a},c=this.uiSettings.getConfig(r,"levelIDText");this.levelIDText=new Konva.Text(c),this.layer.add(this.levelIDRect),this.layer.add(this.levelIDText);r={x:this.x,y:this.y+this.h*(this.uiSettings.properties.levelIDRect.hPct/100),width:this.w*(this.uiSettings.properties.levelNameRect.wPct/100),height:this.h*(this.uiSettings.properties.levelNameRect.hPct/100)},c=this.uiSettings.getConfig(r,"levelNameRect");this.levelNameRect=new Konva.Rect(c);r={x:this.x,y:this.y+this.h*(this.uiSettings.properties.levelIDRect.hPct/100),width:this.w*(this.uiSettings.properties.levelNameText.wPct/100),height:this.h*(this.uiSettings.properties.levelNameText.hPct/100),text:l},c=this.uiSettings.getConfig(r,"levelNameText");this.levelNameText=new Konva.Text(c),this.layer.add(this.levelNameRect),this.layer.add(this.levelNameText);r={x:this.x+this.w*(this.uiSettings.properties.levelIDRect.wPct/100),y:this.y,width:this.w*(this.uiSettings.properties.scrollLeftButtonRect.wPct/100),height:this.h*(this.uiSettings.properties.scrollLeftButtonRect.hPct/100)},c=this.uiSettings.getConfig(r,"scrollLeftButtonRect");this.scrollLeftButtonRect=new Konva.Rect(c);r={x:this.x+this.w*(this.uiSettings.properties.levelIDRect.wPct/100),y:this.y,width:this.w*(this.uiSettings.properties.scrollLeftButtonText.wPct/100),height:this.h*(this.uiSettings.properties.scrollLeftButtonText.hPct/100)},c=this.uiSettings.getConfig(r,"scrollLeftButtonText");this.scrollLeftButtonText=new Konva.Text(c),this.layer.add(this.scrollLeftButtonRect),this.layer.add(this.scrollLeftButtonText);r={x:this.x+this.w*(this.uiSettings.properties.levelIDRect.wPct/100),y:this.y+this.h*(this.uiSettings.properties.scrollLeftButtonRect.hPct/100),width:this.w*(this.uiSettings.properties.scrollRightButtonRect.wPct/100),height:this.h*(this.uiSettings.properties.scrollRightButtonRect.hPct/100)},c=this.uiSettings.getConfig(r,"scrollRightButtonRect");this.scrollRightButtonRect=new Konva.Rect(c);r={x:this.x+this.w*(this.uiSettings.properties.levelIDRect.wPct/100),y:this.y+this.h*(this.uiSettings.properties.scrollLeftButtonRect.hPct/100),width:this.w*(this.uiSettings.properties.scrollRightButtonText.wPct/100),height:this.h*(this.uiSettings.properties.scrollRightButtonText.hPct/100)},c=this.uiSettings.getConfig(r,"scrollRightButtonText");this.scrollRightButtonText=new Konva.Text(c),this.layer.add(this.scrollRightButtonRect),this.layer.add(this.scrollRightButtonText)}}applyTheme(e){this.uiSettings.styles=e.level,this.scrollLeftButtonRect.fill(this.uiSettings.styles.scrollLeftButtonRect.fill),this.scrollLeftButtonRect.stroke(this.uiSettings.styles.scrollLeftButtonRect.stroke),this.scrollLeftButtonText.fill(this.uiSettings.styles.scrollLeftButtonText.fill),this.scrollLeftButtonText.stroke(this.uiSettings.styles.scrollLeftButtonText.stroke),this.scrollRightButtonRect.fill(this.uiSettings.styles.scrollRightButtonRect.fill),this.scrollRightButtonRect.stroke(this.uiSettings.styles.scrollRightButtonRect.stroke),this.levelIDRect.fill(this.uiSettings.styles.levelIDRect.fill),this.levelIDRect.stroke(this.uiSettings.styles.levelIDRect.stroke),this.levelIDText.fill(this.uiSettings.styles.levelIDText.fill),this.levelIDText.stroke(this.uiSettings.styles.levelIDText.stroke),this.levelNameRect.fill(this.uiSettings.styles.levelNameRect.fill),this.levelNameRect.stroke(this.uiSettings.styles.levelNameRect.stroke),this.levelNameText.fill(this.uiSettings.styles.levelNameText.fill),this.levelNameText.stroke(this.uiSettings.styles.levelNameText.stroke),this.layer.batchDraw()}makeScrollbarVisible(e){this.scrollLeftButtonText.visible(e),this.scrollRightButtonText.visible(e),this.layer.batchDraw(),this.isScrollable=e}makeVisible(e){this.scrollLeftButtonRect.visible(e),this.scrollLeftButtonText.visible(e),this.scrollRightButtonRect.visible(e),this.scrollRightButtonText.visible(e),this.levelIDRect.visible(e),this.levelIDText.visible(e),this.levelNameRect.visible(e),this.levelNameText.visible(e),this.layer.batchDraw(),this.isVisible=e,this.isScrollable=e}}class Level{constructor(){this.layer,this.x,this.y,this.w,this.h,this.model,this.view,this.controller,this.levelNumber,this.levelName,this.sectionTemplates}init(e,t,i,s,o,n,a,l,h){this.layer=e,this.x=t,this.y=i,this.w=s,this.h=o,this.levelNumber=a.number,this.levelName=a.name,this.sectionTemplates=a.sections,this.view=new LevelView,this.view.init(e,t,i,s,o,n,this.levelNumber,this.levelName,this.sectionTemplates,l,h),this.controller=new LevelController,this.controller.init(this.model,this.view),this.view.headerView.scrollLeftButtonText.on("click",this.controller.scrollLeft.bind(this.controller)),this.view.headerView.scrollRightButtonText.on("click",this.controller.scrollRight.bind(this.controller)),this.view.makeVisible(!0)}get(){var e=this.view.boardView.sectionCollection.map(function(e){return e.get()});return{name:this.levelName,sections:e}}set(e={sections:[]}){this.view.boardView.sectionCollection.map(function(t,i){return t.set(e.sections[i])})}getData(e){var t="",i=this.view.boardView.sectionCollection;switch(e){case"text/plain":t+=this.levelName+"("+this.levelNumber+")\r\n",i.forEach(function(i){t+=i.getData(e)+"\r\n"});break;case"text/html":i.forEach(function(i){t+=i.getData(e)+"<br>"})}return t}getTitle(){var e="";return e+="<ul>",e+=this.levelName+"("+this.levelNumber+")",this.view.boardView.sectionCollection.forEach(function(t){e+="<ul>",e+=t.getTitle(),e+="</ul>"}),e+="</ul>"}}class LevelView{constructor(){this.uiSettings,this.headerView,this.boardView,this.isVisible=!1}init(e,t,i,s,o,n,a,l,h,r,c){switch(this.uiSettings={styles:r.styles.level,properties:r.properties.level,getConfig:r.getConfig.level},n){case"RECON":this.boardView=new LevelBoardView,this.boardView.init(e,t,i,s,o,n,l,h,r,c);var d=t+s*(this.uiSettings.properties.boardViewRect.wPct/100),u=i;this.headerView=new LevelHeaderView,this.headerView.init(e,d,u,s,o,n,a,l,r);break;case"SEARCH":var g=t+s*(this.uiSettings.properties.scrollLeftButtonRect.wPct/100)+s*(this.uiSettings.properties.levelIDRect.wPct/100),m=i;this.boardView=new LevelBoardView,this.boardView.init(e,g,m,s,o,n,l,h,r,c),this.headerView=new LevelHeaderView,this.headerView.init(e,t,i,s,o,n,a,l,r)}}applyTheme(e){this.uiSettings.styles=e.level,this.headerView.applyTheme(e),this.boardView.applyTheme(e)}makeVisible(e){this.headerView.makeVisible(e),this.boardView.makeVisible(e);var t=e&&this.boardView.noOfSections>this.boardView.noOfSectionAreas;this.headerView.makeScrollbarVisible(t),this.isVisible=e}}class MindMap{constructor(){this.callbacks,this.network,this.zoomInLimit,this.$addToNodePopup,this.$editNodePopup,this.$editEdgePopup,this.appService,this.errorMessage,this.hasError}init(e){var t=this,i=document.getElementById("mindMapNetwork"),s={nodes:new vis.DataSet,edges:new vis.DataSet},o=new NodeModel({x:0,y:0,level:0,label:e.data.name,name:e.data.name,secName:null,levelName:null,shape:"box",fixed:!0,default:!0});s.nodes.add(o);var n={locale:appConst.lang,layout:{randomSeed:1,hierarchical:{enabled:!0,levelSeparation:250,nodeSpacing:50,blockShifting:!1,edgeMinimization:!1,direction:"LR",sortMethod:"directed"}},nodes:{font:{multi:"html"},borderWidth:0,borderWidthSelected:0,widthConstraint:{minimum:75,maximum:75}},edges:{smooth:{enabled:!0,type:"cubicBezier",forceDirection:"horizontal",roundness:.5}},physics:{enabled:!1}};t.callbacks=e.callbacks,t.network=new vis.Network(i,s,n),t.network.body.data.nodes.on("*",t.onNodeChange.bind(t)),t.network.addEventListener("click",t.onClick.bind(t)),t.network.addEventListener("doubleClick",t.onDoubleClick.bind(t)),t.network.addEventListener("oncontext",t.onRightClick.bind(t)),t.network.addEventListener("release",t.onRelease.bind(t)),t.network.addEventListener("afterDrawing",t.onAfterDrawing.bind(t)),t.network.addEventListener("zoom",t.onZoom.bind(t)),t.network.body.container.addEventListener("keydown",t.onKeydown.bind(t)),t.setZoomInLimit(),t.$addToNodePopup=$("#addToNodePopup"),t.$editNodePopup=$("#editNodePopup"),t.$editEdgePopup=$("#editEdgePopup"),t.$addToNodePopup.on("shown.bs.modal",function(e){$(".modal-backdrop").css({"background-color":"transparent"}),t.$addToNodePopup.find("input").eq(0).focus()}),t.$addToNodePopup.on("hidden.bs.modal",function(e){t.$addToNodePopup.find("input").eq(0).val(""),t.network.body.container.focus(),t.errorMessage="",t.hasError=!1,t.callbacks.close()}),t.$addToNodePopup.find("input").eq(0).on("keydown",function(e){var i=$(this);switch(e.keyCode||e.which){case 13:if(t.errorMessage="",i.val()){var s=t.selectedNode();if(s)switch(t.descendentNodeExists(s,i.val())){case!0:t.errorMessage=t.appService.getResourceText("R010"),t.hasError=!0,setTimeout(function(){t.errorMessage="",t.hasError=!1},1e3);break;case!1:var o=new NodeModel({label:i.val(),name:i.val(),secName:s.secName,levelName:s.levelName,isNote:!0});t.callbacks.add(o),t.$addToNodePopup.modal("hide")}}else t.errorMessage=t.appService.getResourceText("R011"),t.hasError=!0,setTimeout(function(){t.errorMessage="",t.hasError=!1},1e3);break;case 27:t.$addToNodePopup.modal("hide")}}),t.$editNodePopup.on("shown.bs.modal",function(e){$(".modal-backdrop").css({"background-color":"transparent"}),t.$editNodePopup.find("input").eq(0).focus()}),t.$editNodePopup.on("hidden.bs.modal",function(e){t.$editNodePopup.find("input").eq(0).val(""),t.network.body.container.focus(),t.errorMessage="",t.hasError=!1,t.callbacks.close()}),t.$editNodePopup.find("input").eq(0).on("keydown",function(e){var i=$(this);switch(e.keyCode||e.which){case 13:if(i.val()){var s=t.selectedNode();if(s)switch(t.siblingNodeExists(s,i.val())){case!0:t.errorMessage=t.appService.getResourceText("R010"),t.hasError=!0,setTimeout(function(){t.errorMessage="",t.hasError=!1},1e3);break;case!1:t.callbacks.update(s,i.val()),t.$editNodePopup.modal("hide")}}else t.errorMessage=t.appService.getResourceText("R011"),t.hasError=!0,setTimeout(function(){t.errorMessage="",t.hasError=!1},1e3);break;case 27:t.$editNodePopup.modal("hide")}}),t.$editEdgePopup.on("shown.bs.modal",function(e){$(".modal-backdrop").css({"background-color":"transparent"}),t.$editEdgePopup.find("input").eq(0).focus()}),t.$editEdgePopup.on("hidden.bs.modal",function(e){t.$editEdgePopup.find("input").eq(0).val(""),t.network.body.container.focus(),t.errorMessage="",t.hasError=!1,t.callbacks.close()}),t.$editEdgePopup.find("input").eq(0).on("keydown",function(e){$(this);switch(e.keyCode||e.which){case 13:break;case 27:t.$editEdgePopup.modal("hide")}}),t.appService=angular.element(document.body).injector().get("AppService"),t.errorMessage="",t.hasError=!1}set(e=[]){var t=this,i={nodes:t.network.body.data.nodes.getDataSet(),edges:t.network.body.data.edges.getDataSet()},s=i.nodes.get({default:!0});i.nodes.clear(),i.edges.clear(),s.forEach(function(s,o){0===o&&(i.nodes.add(s),e.forEach(function(e){e.sections.forEach(function(i){var o=new NodeModel({label:i.name,name:i.name,secName:i.name,levelName:e.name,isNote:!1}),n=t.addTo(s,o);i.notes.forEach(function(s){var o=new NodeModel({id:s.id,label:s.name,name:s.name,secName:i.name,levelName:e.name,isNote:!0});t.addTo(n,o)})})}))}),t.setZoomInLimit()}createEdge(e){return Object.assign({from:0,to:0,label:"",name:"",hidden:!1},e)}onNodeChange(e,t,i){this.network.body.data.nodes.getDataSet(),this.network.body.data.edges.getDataSet()}onClick(e){this.network.body.container.focus()}onDoubleClick(e){var t={x:e.event.center.x,y:e.event.center.y};if(e.nodes.length>0){if(i=this.selectedNode())switch(Math.abs(i.level)){case 1:this.openAddToNodePopup(t,i);break;case 2:this.openEditNodePopup(t,i)}}else if(e.edges.length>0){var i;(i=this.selectedNode())&&this.openEditEdgePopup(t,selectedEdge)}}onRightClick(e){if(e.nodes.length>0){var t=this.selectedNode();if(t){switch(t.collapsed){case!0:this.expand(t);break;case!1:this.collapse(t)}this.network.unselectAll()}}}onRelease(e){this.network.layoutEngine.setupHierarchicalLayout()}onAfterDrawing(e){this.network.layoutEngine.setupHierarchicalLayout()}onKeydown(e){var t=this.selectedNode();if(t)switch(e.keyCode||e.which){case 8:case 46:Math.abs(t.level)>=2&&this.callbacks.delete(t);break;case 27:this.callbacks.close()}}onZoom(){this.network.getScale()<=this.zoomInLimit&&(this.network.moveTo({scale:this.zoomInLimit}),this.setZoomInLimit())}setZoomInLimit(){this.network.fit(),this.zoomInLimit=this.network.getScale()}openAddToNodePopup(e,t){this.$addToNodePopup.find("input").eq(0).val(""),this.$addToNodePopup.modal("show"),this.$addToNodePopup.find(".modal-dialog").eq(0).css({position:"absolute",bottom:"calc(100vh - "+e.y+"px)",left:e.x+"px"})}openEditNodePopup(e,t){this.$editNodePopup.find("input").eq(0).val(t.name),this.$editNodePopup.modal("show"),this.$editNodePopup.find(".modal-dialog").eq(0).css({position:"absolute",bottom:"calc(100vh - "+e.y+"px)",left:e.x+"px"})}openEditEdgePopup(e,t){this.$editEdgePopup.find("input").eq(0).val(t.name),this.$editEdgePopup.modal("show"),this.$editEdgePopup.find(".modal-dialog").eq(0).css({position:"absolute",bottom:"calc(100vh - "+e.y+"px)",left:e.x+"px"})}descendentDataOf(e,t=!1){var i=this,s={nodes:i.network.body.data.nodes.getDataSet(),edges:i.network.body.data.edges.getDataSet()},o={nodes:[],edges:[]};return s.nodes.get(i.network.getConnectedNodes(e.id,"to")).forEach(function(n){t&&n.collapsed||i.descendentDataOf(n,t).nodes.forEach(function(e){s.edges.get({filter:function(t){return t.from===n.id&&t.to===e.id}}).forEach(function(e){o.edges.push(e)}),o.nodes.push(e)});s.edges.get({filter:function(t){return t.from===e.id&&t.to===n.id}}).forEach(function(e){o.edges.push(e)}),o.nodes.push(n)}),o}descendentNodeExists(e,t){this.network.body.data.nodes.getDataSet(),this.network.body.data.edges.getDataSet();return!!this.descendentDataOf(e).nodes.map(e=>e.name).find(e=>t===e)}siblingDataOf(e){var t=this,i={nodes:t.network.body.data.nodes.getDataSet(),edges:t.network.body.data.edges.getDataSet()},s={nodes:[],edges:[]};return i.nodes.get(t.network.getConnectedNodes(e.id,"from")).forEach(function(e){i.nodes.get(t.network.getConnectedNodes(e.id,"to")).forEach(function(t){i.edges.get({filter:function(i){return i.from===e.id&&i.to===t.id}}).forEach(function(e){s.edges.push(e)}),s.nodes.push(t)})}),s}siblingNodeExists(e,t){this.network.body.data.nodes.getDataSet(),this.network.body.data.edges.getDataSet();return!!this.siblingDataOf(e).nodes.map(e=>e.name).find(e=>t===e)}selectedNode(e=0){var t={nodes:this.network.body.data.nodes.getDataSet(),edges:this.network.body.data.edges.getDataSet()};return{nodes:t.nodes.get(this.network.getSelectedNodes()),edges:t.edges.get(this.network.getSelectedEdges())}.nodes[e]}unselect(){this.network.unselectAll()}add(e){var t=this;({nodes:t.network.body.data.nodes.getDataSet(),edges:t.network.body.data.edges.getDataSet()}).nodes.get({filter:function(t){return t.label===e.secName&&t.name===e.secName&&t.secName===e.secName&&t.levelName===e.levelName}}).forEach(function(i){t.addTo(i,e)})}addTo(e,t){var i={nodes:this.network.body.data.nodes.getDataSet(),edges:this.network.body.data.edges.getDataSet()};i.nodes.add(Object.assign(t,{level:(Math.sign(e.level)||1)*(Math.abs(e.level)+1)}));var s=this.createEdge({from:e.id,to:t.id});return i.edges.add(s),this.expand(e),t}deleteFrom(e,t){var i={nodes:this.network.body.data.nodes.getDataSet(),edges:this.network.body.data.edges.getDataSet()};i.nodes.remove(t);var s=i.edges.get({filter:function(i){return i.from===e.id&&i.to===t.id}});return i.edges.remove(s),t}update(e,t){var i={nodes:this.network.body.data.nodes.getDataSet(),edges:this.network.body.data.edges.getDataSet()},s=Object.assign(e,{name:t,label:t});return i.nodes.update(s),s}delete(e){var t={nodes:this.network.body.data.nodes.getDataSet(),edges:this.network.body.data.edges.getDataSet()},i=Object.assign({nodes:[],edges:[]},this.descendentDataOf(e,!1));i.nodes.push(e),t.edges.get({filter:function(t){return t.to===e.id}}).forEach(function(e){i.edges.push(e)}),t.edges.remove(i.edges),t.nodes.remove(i.nodes)}expand(e){var t={nodes:this.network.body.data.nodes.getDataSet(),edges:this.network.body.data.edges.getDataSet()},i=this.descendentDataOf(e,!0);if(i.nodes.length>0){var s={nodes:[],edges:[]};i.nodes.forEach(function(e){Object.assign(e,{hidden:!1}),s.nodes.push(e)}),i.edges.forEach(function(e){Object.assign(e,{hidden:!1}),s.edges.push(e)}),Object.assign(e,{collapsed:!1,borderWidth:0,borderWidthSelected:0}),s.nodes.push(e),t.nodes.update(s.nodes),t.edges.update(s.edges)}}collapse(e){var t={nodes:this.network.body.data.nodes.getDataSet(),edges:this.network.body.data.edges.getDataSet()},i=this.descendentDataOf(e,!0);if(i.nodes.length>0){var s={nodes:[],edges:[]};i.nodes.forEach(function(e){Object.assign(e,{hidden:!0}),s.nodes.push(e)}),i.edges.forEach(function(e){Object.assign(e,{hidden:!0}),s.edges.push(e)}),Object.assign(e,{collapsed:!0,borderWidth:1,borderWidthSelected:2}),s.nodes.push(e),t.nodes.update(s.nodes),t.edges.update(s.edges)}}applyTheme(e){this.network.setOptions({nodes:{font:{color:e.color,bold:{color:e.activeColor}},color:{border:e.borderColor,background:e.backgroundColor,highlight:{border:e.activeBorderColor,background:e.activeBackgroundColor},hover:{border:e.activeBorderColor,background:e.activeBackgroundColor}}}})}}class NodeModel{constructor(e={}){return Object.assign({label:"undefined",name:null,secName:null,levelName:null,isNote:!1,shape:"box",fixed:!1,default:!1,collapsed:!1,borderWidth:0,borderWidthSelected:0},e)}}class NoteForm{constructor(){this.wsName,this.secName,this.levelName,this.noteExists,this.template,this.oldNote,this.note,this.tags,this.widgets,this.selectedWidget,this.options,this.bcList,this.scenariosText,this.conditionsTable}init(e,t){this.wsName=e.wsName||null,this.levelName=e.levelName||null,this.secName=e.secName||null,this.noteExists=e.noteExists||!1,this.template=e.template||[],this.oldNote=$.extend(!0,{},e.note),this.note=$.extend(!0,{},e.note),this.tags=e.tags||[],this.widgets=[],this.selectedWidget=null,this.options={space:"",openSquareBracket:"[",closeSquareBracket:"]",openRoundBracket:"(",closeRoundBracket:")",comma:","},this.scenariosText="",this.deleteNote=this.deleteNoteForm.bind(this,t.delete),this.submitNote=this.submitNoteForm.bind(this,t.submit),$("#note").on("hidden.bs.modal",this.closeNoteForm.bind(this,t.close)),$("#note").modal("show")}generateTestScenarios(){this.scenariosText="",this.bcList.length>0&&(this.scenariosText+="@startsection\n",this.generatePostiveScenarios(this.scenariosText),this.generateNegativeScenarios(this.scenariosText),this.scenariosText+="@endsection");var e=document.getElementById("widgetScenarios").value.match(new RegExp(/@startsection(.|\s)*@endsection/));e?document.getElementById("widgetScenarios").value=document.getElementById("widgetScenarios").value.replace(e[0],this.scenariosText):(this.scenariosText=this.scenariosText?this.scenariosText+"\n":this.scenariosText,document.getElementById("widgetScenarios").value=this.scenariosText+document.getElementById("widgetScenarios").value)}generatePostiveScenarios(e){this.scenariosText+="positive scenarios:\n";var t=[],i=0;this.bcList.forEach(function(e){i=Math.max(i,e.value.positive.length)});for(var s=0;s<i;s++){var o=[];this.bcList.forEach(function(e){e.value.positive&&e.value.positive.length>0&&o.push(e.value.positive[Math.min(s,e.value.positive.length-1)])}),t.push(o),this.scenariosText+=t.indexOf(o)+1+"."+o+"\n"}}generateNegativeScenarios(e){var t=this;t.scenariosText+="negative scenarios:\n";var i=[];t.bcList.forEach(function(e,s){e.value.negative.forEach(function(e){var o=[];o.push(e),t.bcList.forEach(function(e,t){if(e.value.positive&&e.value.positive.length>0){if(s==t)return;o.push(e.value.positive[Math.floor(Math.random()*e.value.positive.length)])}}),i.push(o),t.scenariosText+=i.indexOf(o)+1+"."+o+"\n"})})}openAccordion(e){switch(e){case"widgetScenarios":var t=document.getElementById("widgetConditions").value;if(t){var i=t.replace(/(?:\r\n|\r|\n)/g,"").match(new RegExp("@start(.*)@end"));if(i){var s=angular.element(document.body).injector().get("AppService");this.bcList=s.stringToJson(i,this.options)}else this.bcList=[]}else this.bcList=[];this.generateTestScenarios()}}openConditionsTable(e){this.conditionsTable=new ConditionsTable,this.conditionsTable.init(e),this.conditionsTable.openConditionsTable()}loadWidgets(){var e=this,t=appConst.levelWidgetMapping[e.levelName].type;appConst.levelWidgetMapping[e.levelName].category;e.widgets=[],e.selectedWidget=null;var i=localStorage.getItem("publicToken");angular.element(document.body).injector().get("WidgetService").getPublicWidgets(i).then(function(i){i&&i.length>0&&(e.widgets=i.filter(e=>e.info.type===t))})}setSelectedWidget(e){var t=this;if(e){var i=localStorage.getItem("publicToken");angular.element(document.body).injector().get("WidgetService").getPublicWidgetById(e,i).then(function(e){t.selectedWidget=e})}else t.selectedWidget=null}bindSelectedWidget(e){this.note.lines.forEach(function(t){t.elements.forEach(function(t){switch(t.id){case"widgetConditions":t.value=e.data.conditions||"";break;case"widgetCriteria":t.value=e.data.criteria||"";break;case"widgetIssues":t.value=e.data.issues||"";break;case"widgetActions":t.value=e.data.actions||"";break;case"widgetHeuristics":t.value=e.data.heuristics||"";break;case"widgetData":t.value=e.data.data||""}})}),document.getElementById("infoTab").click()}submitNoteForm(e){this.noteExists?e(this.oldNote,this.note):e(this.note)}deleteNoteForm(e){e(this.note)}closeNoteForm(e){e(),$("#note").modal("hide")}}class NoteModel{constructor(e={id:-1,name:"",secName:"",levelName:""},t=new ProjectTemplateModel){this.id=e.id,this.name=e.name,this.secName=e.secName,this.levelName=e.levelName;var i=t.levels.find(t=>t.name===e.levelName).sections.find(t=>t.name===e.secName).notes.find(e=>"default"===e.name);this.lines=i.lines.map(function(e,t){return{elements:e.elements.map(function(e,i){var s=e.id||"line_"+t+"_element_"+i,o=e.label||"",n=e.value||"";switch(e.type){case"VALUE-NUMSTRING":n=parseInt(e.value)||0;break;case"VALUE-LIST":n=e.value[0]}return{id:s,label:o,value:n}})}}),this.iNotes="",this.links=""}}class ProjectDataModel{constructor(e={_id:-1,name:"",description:"",details:{levels:[],jottings:[],notes:[],questions:[]},templateName:""}){this._id=e._id,this.name=e.name,this.description=e.description,this.details=e.details,this.templateName=e.templateName}uniqueId(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}newNote(e={name:"",secName:"",levelName:""},t=new ProjectTemplateModel){return new NoteModel({id:e.id||this.uniqueId(),name:e.name,secName:e.secName,levelName:e.levelName},t)}createNoteFromNode(e,t=new ProjectTemplateModel){return e.id=e.id||this.uniqueId(),new NoteModel({id:e.id,name:e.name,secName:e.secName,levelName:e.levelName},t)}createNodeFromNote(e){return e.id=e.id||this.uniqueId(),new NodeModel({id:e.id,label:e.name,name:e.name,secName:e.secName,levelName:e.levelName,isNote:!0})}addJotting(e,t){var i=t+1;this.details.jottings.splice(i,0,e)}deleteJotting(e){if(e>=0)return this.details.jottings.splice(e,1)}addNote(e,t){var i=t+1;this.details.notes.splice(i,0,e)}deleteNote(e){if(e>=0)return this.details.notes.splice(e,1)}addQuestion(e,t){var i=t+1;this.details.questions.splice(i,0,e)}deleteQuestion(e){if(e>=0)return this.details.questions.splice(e,1)}}class Project{constructor(e={model:{},views:{},template:{},uiSettings:{}}){for(var t in this.model=new ProjectDataModel(e.model),this.template=new ProjectTemplateModel(e.template),this.uiSettings=new ProjectUisettingModel(e.uiSettings),this.views=new Object,viewList)switch(t){case"workspace":this.views[t]=this.newWorkspaceView(viewList[t]);break;case"mindMap":this.views[t]=this.newMindMapView(viewList[t])}this.noteForm,this.selectedWorkspaceIndex=-1,this.undoManager=new UndoManager,this.open=!0,this.applyTheme()}newWorkspaceView(e){var t=new Array,i=0;for(var s in e)t[i]=new Workspace,t[i].init(e[s],s,this.template,this.uiSettings),t[i].set(this.model.details.levels),t[i].makeVisible(!1),++i;return t}newMindMapView(e){var t={data:this.model,callbacks:{add:this.addNodeAction.bind(this),update:this.updateNodeAction.bind(this),delete:this.deleteNodeAction.bind(this),close:this.unselectNodeAction.bind(this)}},i=new MindMap;return i.init(t),i}startSession(e){this.views.workspace.forEach(e=>e.makeVisible(!1)),this.selectedWorkspaceIndex=this.views.workspace.findIndex(t=>t.name===e),this.views.workspace[this.selectedWorkspaceIndex].makeVisible(!0),this.views.workspace[this.selectedWorkspaceIndex].set(this.model.details.levels),this.views.mindMap.set(this.model.details.levels),this.undoManager.clear(),this.applyTheme()}abortSession(){this.views.workspace.forEach(e=>e.makeVisible(!1)),this.selectedWorkspaceIndex=-1}openNoteForm(e){var t={add:this.addNoteAction.bind(this),delete:this.deleteNoteAction.bind(this),update:this.updateNoteAction.bind(this),submit:e.noteExists?this.updateNoteAction.bind(this):this.addNoteAction.bind(this),close:this.unselectNoteAction.bind(this)};e.noteExists||(e.note=this.model.newNote({name:"new",secName:e.secName,levelName:e.levelName},this.template)),e.template=this.template.noteTemplate(e.secName,e.levelName,e.wsName),e.tags=this.getSuggestTags(e.wsName),this.noteForm=new NoteForm,this.noteForm.init(e,t)}addNoteAction(e,t=-1,i=!0){var s=this.model.createNodeFromNote(e);t=this.views.workspace[this.selectedWorkspaceIndex].add(e,t),this.views.mindMap.add(s),i&&this.undoManager.add({undo:this.deleteNoteAction.bind(this,e,!1),redo:this.addNoteAction.bind(this,e,t,!1)})}updateNoteAction(e,t,i=!0){var s=this.model.createNodeFromNote(e);this.views.mindMap.update(s,t.name);this.views.workspace[this.selectedWorkspaceIndex].update(t),i&&this.undoManager.add({undo:this.updateNoteAction.bind(this,t,e,!1),redo:this.updateNoteAction.bind(this,e,t,!1)})}deleteNoteAction(e,t=!0){var i=this.model.createNodeFromNote(e),s=this.views.workspace[this.selectedWorkspaceIndex].delete(e);this.views.mindMap.delete(i),t&&this.undoManager.add({undo:this.addNoteAction.bind(this,e,s,!1),redo:this.deleteNoteAction.bind(this,e,!1)})}unselectNoteAction(){this.views.workspace[this.selectedWorkspaceIndex].unselect()}addNodeAction(e,t=-1,i=!0){var s=this.model.createNoteFromNode(e,this.template);this.views.mindMap.add(e),e.isNote&&(t=this.views.workspace[this.selectedWorkspaceIndex].add(s,t)),i&&this.undoManager.add({undo:this.deleteNodeAction.bind(this,e,!1),redo:this.addNodeAction.bind(this,e,t,!1)})}updateNodeAction(e,t,i=!0){this.model.createNoteFromNode(e,this.template);var s=Object.assign({},e),o=this.views.mindMap.update(e,t),n=this.model.createNoteFromNode(o,this.template);this.views.workspace[this.selectedWorkspaceIndex].update(n),i&&this.undoManager.add({undo:this.updateNodeAction.bind(this,o,s.name,!1),redo:this.updateNodeAction.bind(this,s,t,!1)})}deleteNodeAction(e,t=!0){var i=this.model.createNoteFromNode(e,this.template);if(this.views.mindMap.delete(e),e.isNote)var s=this.views.workspace[this.selectedWorkspaceIndex].delete(i);t&&this.undoManager.add({undo:this.addNodeAction.bind(this,e,s,!1),redo:this.deleteNodeAction.bind(this,e,!1)})}unselectNodeAction(){this.views.mindMap.unselect()}applyTheme(){var e=this,t=getComputedStyle(document.getElementById("ist")),i={color:t.getPropertyValue("--theme-color").trim(),backgroundColor:t.getPropertyValue("--theme-background-color").trim(),borderColor:t.getPropertyValue("--theme-border-color").trim(),activeColor:t.getPropertyValue("--theme-active-color").trim(),activeBackgroundColor:t.getPropertyValue("--theme-active-background-color").trim(),activeBorderColor:t.getPropertyValue("--theme-active-border-color").trim(),disabledColor:t.getPropertyValue("--theme-disabled-color").trim(),disabledBackgroundColor:t.getPropertyValue("--theme-disabled-background-color").trim(),borderLineColor:t.getPropertyValue("--theme-border-line-color").trim(),footerColor:t.getPropertyValue("--theme-footer-color").trim(),footerBackgroundColor:t.getPropertyValue("--theme-footer-background-color").trim(),footerMenuBackgroundColor:t.getPropertyValue("--theme-footer-menu-background-color").trim(),scrollbarColor:t.getPropertyValue("--theme-scrollbar-color").trim(),scrollbarBackgroundColor:t.getPropertyValue("--theme-scrollbar-background-color").trim(),activeScrollbarColor:t.getPropertyValue("--theme-active-scrollbar-color").trim()},s={workspace:{},level:{boardViewRect:{fill:i.disabledBackgroundColor,stroke:"lightgrey",shadowColor:"black"},scrollLeftButtonRect:{fill:"hsl(4, 3%, 76%)",stroke:"hsl(165, 53%, 81%)",shadowColor:"black"},scrollLeftButtonText:{fontFamily:"FontAwesome",fill:"#555"},scrollRightButtonRect:{fill:"hsl(4, 3%, 76%)",stroke:"hsl(165, 53%, 81%)",shadowColor:"black"},scrollRightButtonText:{fontFamily:"FontAwesome",fill:"#555"},levelIDRect:{fill:"black",stroke:"lightgrey",shadowColor:"black"},levelIDText:{fontFamily:"Roboto",fill:"white"},levelNameRect:{fill:"black",stroke:"lightgrey",shadowColor:"black"},levelNameText:{fontFamily:"Roboto",fill:"white"}},section:{secNameRect:{fill:i.backgroundColor,stroke:i.borderColor,shadowColor:"black"},secNameText:{fontFamily:"Roboto",fill:i.color},scrollLeftButtonRect:{fill:"hsl(4, 3%, 76%)",stroke:"hsl(165, 53%, 81%)",shadowColor:"black"},scrollLeftButtonText:{fontFamily:"FontAwesome",fill:"#555"},scrollRightButtonRect:{fill:"hsl(4, 3%, 76%)",stroke:"hsl(165, 53%, 81%)",shadowColor:"black"},scrollRightButtonText:{fontFamily:"FontAwesome",fill:"#555"},boardViewRect:{fill:"antiquewhite",stroke:"lightgrey",shadowColor:"black"}},board:{konvaRect:{fill:"hsl(29, 95%, 76%)",stroke:"hsl(29, 95%, 76%)",shadowColor:"black"},konvaText:{fontFamily:"Roboto",fill:"#555"},selectedKonvaRect:{fill:"hsl(9, 1%, 69%)",stroke:"hsl(165, 53%, 81%)",shadowColor:"black"}}};e.uiSettings.styles=$.extend(!0,{},e.uiSettings.styles,s),e.views.workspace.forEach(function(t){t.applyTheme(e.uiSettings.styles)}),e.views.mindMap.applyTheme(i)}download(){var e=this.name+(new Date).toLocaleString(),t="data:text/html;charset=utf-8,"+encodeURIComponent(this.getData("text/html")),i=document.createElement("a");i.download=e,i.href=t,i.onclick=function(e){document.body.removeChild(e.target)},i.style.display="none",document.body.appendChild(i),i.click()}getData(e){var t="";switch(e){case"text/plain":t+=this.name+"\r\n",t+="Created on: ",t+=(new Date).toLocaleString()+"\r\n",this.views.workspace.forEach(function(i){t+=i.getData(e)}),t+="NOTES:\r\n",this.model.details.notes.forEach(function(e,i){t+=i+1+". "+e+"\r\n"}),t+="QUESTIONS:\r\n",this.model.details.questions.forEach(function(e,i){t+=i+1+". "+e+"\r\n"});break;case"text/html":t+="<head>",t+="<style>",t+=".contents {",t+="display: inline-block;",t+="padding: 7px;",t+="line-height: 1.6;",t+="border: 1px solid #a2a9b1;",t+="background-color: #f8f9fa;",t+="font-size: 95%;",t+="margin-bottom: 5px;",t+="padding: 5px;",t+="}",t+="a {",t+="text-decoration:none;",t+="}",t+=".content-heading ,.workspace-container {",t+="background-color : #f8f9fa;",t+="text-align: center;",t+="}",t+="li {",t+="list-style-type: none;",t+="}",t+="</style>",t+="</head>",t+="<h3>",t+=this.name,t+="</h3>",t+="<h4>",t+="Downloaded on: ",t+=(new Date).toLocaleString(),t+="</h4>",t+='<div class = "contents">',t+='<div class = "content-heading">Contents</div>',t+="<table>",t+="<tr>",this.views.workspace.forEach(function(e){t+=e.getTitle()}),t+="</tr>",t+="</table>",t+="</div>",this.views.workspace.forEach(function(i){t+=i.getData(e)}),t+="<hr>",t+="NOTES:<br>",0==this.model.details.notes.length&&(t+="(empty)",t+="<br>"),this.model.details.notes.forEach(function(e,i){t+=i+1+". "+e+"<br>"}),t+="<br>QUESTIONS:<br>",0==this.model.details.questions.length&&(t+="(empty)",t+="<br>"),this.model.details.questions.forEach(function(e,i){t+=i+1+". "+e+"<br>"})}return t}getSuggestTags(e){var t=this.model.details.levels,i=[].concat(...t.map(e=>e.sections)).filter(e=>e.notes.length).map(e=>e.notes.map(t=>e.name+" : "+t.name));return[].concat(...i)}}class ProjectTemplateModel{constructor(e={name:"",levels:[]}){this.name=e.name,this.levels=e.levels}noteTemplate(e,t,i=""){if(e&&t&&i){var s=this.levels.find(e=>e.name===t).sections.find(t=>t.name===e).notes.find(e=>"default"===e.name);return{name:s.name,lines:s.lines.filter(e=>e.type===i)}}}}class ProjectUisettingModel{constructor(e={_id:-1,name:"",description:"",details:{levels:[],jottings:[],notes:[],questions:[]},templateName:""}){this._id=e._id,this.name=e.name,this.description=e.description,this.details=e.details,this.templateName=e.templateName}uiSettingsConfig(e){var t={styles:this.styles[e],properties:this.properties[e]};return function(e,i){var s=Object.assign({},e,t.styles[i]);switch(s.x=s.x+(s.strokeWidth?s.strokeWidth/2:0),s.y=s.y+(s.strokeWidth?s.strokeWidth/2:0),s.width=s.width-(s.strokeWidth||0),s.height=s.height-(s.strokeWidth||0),s.verticalAlign){case"top":s.y=s.y;break;case"center":s.y=s.y+s.height/2-s.fontSize/2;break;case"bottom":s.y=s.y+s.height-s.fontSize}return s}}}class SectionArea{constructor(){this.x,this.y,this.w,this.h,this.sectionID=-1}init(e,t,i,s,o){this.x=e,this.y=t,this.w=i,this.h=s,this.sectionID=o}}class SectionBoardView{constructor(){this.layer,this.x,this.y,this.w,this.h,this.uiSettings,this.boardViewRect,this.scrollLeftButtonRect,this.scrollLeftButtonText,this.scrollRightButtonRect,this.scrollRightButtonText,this.boards=[],this.noOfBoards=0,this.noOfNotes=0,this.isVisible=!1,this.isLeftScrollable=!1,this.isRightScrollable=!1}init(e,t,i,s,o,n){this.layer=e,this.x=t,this.y=i,this.w=s,this.h=o,this.uiSettings={styles:n.styles.section,properties:n.properties.section,getConfig:n.getConfig.section};var a={x:this.x,y:this.y,width:this.w,height:this.h},l=this.uiSettings.getConfig(a,"boardViewRect");this.boardViewRect=new Konva.Rect(l),this.layer.add(this.boardViewRect);n.styles.board;var h=n.properties.board,r=(n.getConfig.board,this.x),c=this.y,d=h.w+2*h.minGapW,u=h.h+2*h.minGapH,g=Math.floor(this.w/d),m=Math.floor(this.h/u),p=this.w/g,v=this.h/m,w=(p-h.w)/2,f=(v-h.h)/2;this.noOfBoards=g*m;for(var b=0;b<this.noOfBoards;++b){t=r+b%g*p,i=c+Math.floor(b/g)*v,s=p,o=v;var N=w,y=f;this.boards[b]=new Board,this.boards[b].init(this.layer,t,i,s,o,N,y,n)}t=this.x,i=this.y,s=this.w,o=this.h;this.boards.length>0&&(t=this.boards[0].x,i=this.boards[0].y,s=this.boards[0].w*(this.uiSettings.properties.scrollLeftButtonRect.wPct/100),o=this.boards[0].h);a={x:t,y:i,width:s,height:o},l=this.uiSettings.getConfig(a,"scrollLeftButtonRect");this.scrollLeftButtonRect=new Konva.Rect(l);a={x:t,y:i,width:s,height:o},l=this.uiSettings.getConfig(a,"scrollLeftButtonText");this.scrollLeftButtonText=new Konva.Text(l),this.layer.add(this.scrollLeftButtonRect),this.layer.add(this.scrollLeftButtonText);t=this.x,i=this.y,s=this.w,o=this.h;this.boards.length>0&&(t=this.boards[this.boards.length-1].x,i=this.boards[this.boards.length-1].y,s=this.boards[this.boards.length-1].w*(this.uiSettings.properties.scrollLeftButtonRect.wPct/100),o=this.boards[this.boards.length-1].h,t+=this.boards[this.boards.length-1].w-s);a={x:t,y:i,width:s,height:o},l=this.uiSettings.getConfig(a,"scrollRightButtonRect");this.scrollRightButtonRect=new Konva.Rect(l);a={x:t,y:i,width:s,height:o},l=this.uiSettings.getConfig(a,"scrollRightButtonText");this.scrollRightButtonText=new Konva.Text(l),this.layer.add(this.scrollRightButtonRect),this.layer.add(this.scrollRightButtonText)}leftmostBoard(e=!1){switch(e){case!0:return this.boards.find(function(e){return null!==e.note});case!1:return this.boards.find(function(e){return!0})}}rightmostBoard(e=!1){var t=void 0;switch(e){case!0:this.boards.forEach(function(e){e.note&&(t=e)});break;case!1:this.boards.forEach(function(e){t=e})}return t}displayNoteAt(e,t){-1!==e&&(this.boards[e].attachNote(t),this.boards[e].makeVisible(this.isVisible&&!0))}displayNoteAtStart(e){if(0===this.noOfNotes)this.displayNoteAt(0,e),++this.noOfNotes;else if(this.noOfNotes<this.noOfBoards){for(var t=this.noOfNotes-1;t>=0;--t)this.boards[t+1].attachNote(this.boards[t].note),this.boards[t+1].makeVisible(this.isVisible&&!0);this.displayNoteAt(0,e),++this.noOfNotes}else if(this.noOfNotes===this.noOfBoards){for(t=this.noOfNotes-1;t>=0;--t)this.boards[t+1]&&(this.boards[t+1].attachNote(this.boards[t].note),this.boards[t+1].makeVisible(this.isVisible&&!0));this.displayNoteAt(0,e)}}displayNoteAtEnd(e){if(this.noOfNotes<this.noOfBoards)this.displayNoteAt(this.noOfNotes,e),++this.noOfNotes;else if(this.noOfNotes===this.noOfBoards){for(var t=0;t<this.noOfNotes-1;++t)this.boards[t].attachNote(this.boards[t+1].note),this.boards[t].makeVisible(this.isVisible&&!0);this.displayNoteAt(this.noOfNotes-1,e)}}deleteNote(e){this.boards[e].unattachNote(),this.boards[e].makeVisible(this.isVisible&&!1);for(var t=e;t<this.noOfNotes-1;++t)this.boards[t].attachNote(this.boards[t+1].note),this.boards[t].makeVisible(this.isVisible&&!0),this.boards[t+1].unattachNote(),this.boards[t+1].makeVisible(this.isVisible&&!1);--this.noOfNotes}clear(){var e=this;e.boards.forEach(function(t){t.unattachNote(),t.makeVisible(e.isVisible&&!1)}),e.noOfNotes=0}selectBoard(e){this.boards.forEach(function(t,i){t.unhighlightNote(),i===e&&t.highlightNote()})}unselectBoard(){this.boards.forEach(function(e){e.unhighlightNote()})}relocateAt(e,t){this.boardViewRect.setX(e+(this.boardViewRect.x()-this.x)),this.boardViewRect.setY(t+(this.boardViewRect.y()-this.y)),this.scrollLeftButtonRect.setX(e+(this.scrollLeftButtonRect.x()-this.x)),this.scrollLeftButtonRect.setY(t+(this.scrollLeftButtonRect.y()-this.y)),this.scrollLeftButtonText.setX(e+(this.scrollLeftButtonText.x()-this.x)),this.scrollLeftButtonText.setY(t+(this.scrollLeftButtonText.y()-this.y)),this.scrollRightButtonRect.setX(e+(this.scrollRightButtonRect.x()-this.x)),this.scrollRightButtonRect.setY(t+(this.scrollRightButtonRect.y()-this.y)),this.scrollRightButtonText.setX(e+(this.scrollRightButtonText.x()-this.x)),this.scrollRightButtonText.setY(t+(this.scrollRightButtonText.y()-this.y));for(var i=0;i<this.noOfBoards;++i)this.boards[i].konvaRect.setX(e+(this.boards[i].konvaRect.x()-this.x)),this.boards[i].konvaRect.setY(t+(this.boards[i].konvaRect.y()-this.y)),this.boards[i].konvaText.setX(e+(this.boards[i].konvaText.x()-this.x)),this.boards[i].konvaText.setY(t+(this.boards[i].konvaText.y()-this.y));this.x=e,this.y=t}applyTheme(e){this.uiSettings.styles=e.section,this.boardViewRect.fill(this.uiSettings.styles.boardViewRect.fill),this.boardViewRect.stroke(this.uiSettings.styles.boardViewRect.stroke),this.scrollLeftButtonRect.fill(this.uiSettings.styles.scrollLeftButtonRect.fill),this.scrollLeftButtonRect.stroke(this.uiSettings.styles.scrollLeftButtonRect.stroke),this.scrollLeftButtonText.fill(this.uiSettings.styles.scrollLeftButtonText.fill),this.scrollLeftButtonText.stroke(this.uiSettings.styles.scrollLeftButtonText.stroke),this.scrollRightButtonRect.fill(this.uiSettings.styles.scrollRightButtonRect.fill),this.scrollRightButtonRect.stroke(this.uiSettings.styles.scrollRightButtonRect.stroke),this.scrollRightButtonText.fill(this.uiSettings.styles.scrollRightButtonText.fill),this.scrollRightButtonText.stroke(this.uiSettings.styles.scrollRightButtonText.stroke),this.boards.forEach(function(t){t.applyTheme(e)}),this.layer.batchDraw()}makeScrollable(e=!1,t=!1){this.scrollLeftButtonRect.visible(e),this.scrollLeftButtonText.visible(e),this.scrollRightButtonRect.visible(t),this.scrollRightButtonText.visible(t),this.layer.batchDraw(),this.isLeftScrollable=e,this.isRightScrollable=t}makeVisible(e,t=!1,i=!1){var s=this;s.boardViewRect.visible(e),s.boards.forEach(function(t,i){var o=i<s.noOfNotes;t.makeVisible(e&&o)}),s.makeScrollable(t,i),s.layer.batchDraw(),s.isVisible=e,s.isLeftScrollable=t,s.isRightScrollable=i}}class SectionController{constructor(){this.model,this.view,this.wsName,this.levelName,this.secName}init(e,t,i,s,o){this.model=e,this.view=t,this.wsName=i,this.levelName=s,this.secName=o}startNoteIndex(){var e=this.view.boardView.leftmostBoard(!0);return e?this.model.getIndexOf(e.note.id):0}endNoteIndex(){var e=this.view.boardView.rightmostBoard(!0);return e?this.model.getIndexOf(e.note.id):this.model.notes.length-1}load(e=[]){this.model.init(e);var t=this.startNoteIndex();this.displayNotesFrom(t)}displayNoteForm(e){var t=angular.element($("#workspace")).scope();switch(-1!==e){case!0:this.selectNote(e);var i={wsName:this.wsName,levelName:this.levelName,secName:this.secName,noteExists:!0,note:this.view.boardView.boards[e].note};break;case!1:this.unselectNote();i={wsName:this.wsName,levelName:this.levelName,secName:this.secName,noteExists:!1,note:null}}t.project.openNoteForm(i)}addNote(e,t=-1){var i=this.endNoteIndex();t=-1!==t?t:i+1,this.model.add(e,t);var s=this.startNoteIndex();return this.displayNotesFrom(s+1),t}updateNote(e){this.model.update(e);var t=this.view.boardView.boards.findIndex(t=>t.note.id===e.id);this.view.boardView.displayNoteAt(t,e),this.unselectNote(),this.alterScrollbar()}deleteNote(e){var t=this.model.getIndexOf(e.id);this.model.delete(e);var i=this.startNoteIndex();return this.displayNotesFrom(i),t}scrollLeft(){var e=this.startNoteIndex();this.endNoteIndex();e>0&&this.displayNotesFrom(e-1)}scrollRight(){var e=this.startNoteIndex();this.endNoteIndex()<this.model.notes.length-1&&this.displayNotesFrom(e+1)}selectNote(e){this.view.boardView.unselectBoard(),this.view.boardView.selectBoard(e)}unselectNote(){this.view.boardView.unselectBoard()}displayNotesFrom(e){var t=this,i=t.model.displayNotesFrom(e,t.view.boardView.noOfBoards);t.view.boardView.clear(),i.forEach(function(e){t.view.boardView.displayNoteAtEnd(e)}),t.unselectNote(),t.alterScrollbar()}alterScrollbar(){var e=this.startNoteIndex()>0,t=this.endNoteIndex()<this.model.notes.length-1;this.view.boardView.makeScrollable(e,t)}}class SectionHeaderView{constructor(){this.layer,this.x,this.y,this.w,this.h,this.secNameRect,this.secNameText,this.isVisible=!1}init(e,t,i,s,o,n,a){this.layer=e,this.x=t,this.y=i,this.w=s,this.h=o,this.uiSettings={styles:a.styles.section,properties:a.properties.section,getConfig:a.getConfig.section};var l={x:this.x,y:this.y,width:this.w*(this.uiSettings.properties.secNameRect.wPct/100),height:this.h*(this.uiSettings.properties.secNameRect.hPct/100)},h=this.uiSettings.getConfig(l,"secNameRect");this.secNameRect=new Konva.Rect(h);l={x:this.x,y:this.y,width:this.w*(this.uiSettings.properties.secNameText.wPct/100),height:this.h*(this.uiSettings.properties.secNameText.hPct/100),text:n},h=this.uiSettings.getConfig(l,"secNameText");this.secNameText=new Konva.Text(h),this.layer.add(this.secNameRect),this.layer.add(this.secNameText)}relocateAt(e,t){this.secNameRect.setX(e+(this.secNameRect.x()-this.x)),this.secNameRect.setY(t+(this.secNameRect.y()-this.y)),this.secNameText.setX(e+(this.secNameText.x()-this.x)),this.secNameText.setY(t+(this.secNameText.y()-this.y)),this.x=e,this.y=t}applyTheme(e){this.uiSettings.styles=e.section,this.secNameRect.fill(this.uiSettings.styles.secNameRect.fill),this.secNameRect.stroke(this.uiSettings.styles.secNameRect.stroke),this.secNameText.fill(this.uiSettings.styles.secNameText.fill),this.secNameText.stroke(this.uiSettings.styles.secNameText.stroke),this.layer.batchDraw()}makeVisible(e){this.secNameRect.visible(e),this.secNameText.visible(e),this.layer.batchDraw(),this.isVisible=e}}class Section{constructor(){this.model,this.view,this.controller,this.wsName,this.levelName,this.secName,this.sectionTemplate}init(e,t,i,s,o,n,a,l,h,r,c){this.wsName=a,this.levelName=l,this.secName=h.name,this.sectionTemplate=h,this.model=new SectionModel,this.view=new SectionView,this.view.init(e,t,i,s,o,n,this.secName,r),this.controller=new SectionController,this.controller.init(this.model,this.view,this.wsName,this.levelName,this.secName),this.view.boardView.boardViewRect.on("click",this.controller.displayNoteForm.bind(this.controller,-1)),this.view.boardView.scrollLeftButtonText.on("click",this.controller.scrollLeft.bind(this.controller)),this.view.boardView.scrollRightButtonText.on("click",this.controller.scrollRight.bind(this.controller));for(var d=0;d<this.view.boardView.noOfBoards;++d)this.view.boardView.boards[d].konvaText.on("click",this.controller.displayNoteForm.bind(this.controller,d));this.view.makeVisible(c)}get(){return{name:this.secName,notes:this.model.notes}}set(e={notes:[]}){this.controller.load(e.notes)}getData(e){var t="",i=this.model.notes;switch(e){case"text/plain":t+=this.secName+"\r\n",0==i.length?t+="(empty)\r\n":i.forEach(function(e,i){t+=i+1+". "+e.name+"\r\n",e.lines.forEach(function(e){e.elements.forEach(function(e){t+=(e.label||"")+" "+(e.value||"")+"\r\n"})})});break;case"text/html":t+="<h3><a name="+this.wsName+this.levelName+this.secName+">"+this.secName+"</a></h2>",0==i.length&&(t+="(empty)"),i.forEach(function(e,i){t+=i+1+". "+(e.name||"")+"<br>",e.lines.forEach(function(e){e.elements.forEach(function(e){t+=(e.label||"")+" "+(e.value||"")}),t+="<br>"}),t+="Notes "+(e.lines.iNotes||"")+"<br>",t+="Links "+(e.lines.links||"")+"<br>"})}return t}getTitle(){var e="";return e+="<li>",e+="<a href = #"+this.wsName+this.levelName+this.secName+">",e+=this.secName,e+="</a>",e+="</li>"}}class SectionModel{constructor(){this.notes=[]}init(e=[]){this.notes=e}noteExists(e){return this.notes.findIndex(t=>t.id===e)>=0}validIndex(e){return e<0?0:e>=this.notes.length?this.notes.length-1:e}getById(e){return this.notes.find(t=>t.id===e)}getIndexOf(e){return this.notes.findIndex(t=>t.id===e)}getPrevOf(e,t=!1,i=1){var s=this.validIndex(e);return this.notes.filter(function(e,o){switch(t){case!0:return o<=s&&o>s-i;case!1:return o<s&&o>=s-i}})}getNextOf(e,t=!1,i=1){var s=this.validIndex(e);return this.notes.filter(function(e,o){switch(t){case!0:return o>=s&&o<s+i;case!1:return o>s&&o<=s+i}})}displayNotesFrom(e,t=0){var i=[],s=[];return s=this.getNextOf(e,!0,t),this.getPrevOf(e,!1,t-s.length).forEach(function(e){i.push(e)}),s.forEach(function(e){i.push(e)}),i}duplicateExists(e){return this.notes.find(t=>t.name===e)}add(e,t){switch(!0){case t<0:this.notes.unshift(e);break;case t>=0&&t<=this.notes.length:this.notes.splice(t,0,e);break;case t>this.notes.length:default:this.notes.push(e)}}update(e){var t=this.getIndexOf(e.id);if(-1!==t)return this.notes[t]=e,this.notes[t]}delete(e){return{id:e.id,index:this.getIndexOf(e.id),data:[],oldData:this.notes.splice(this.getIndexOf(e.id),1)}}size(){return this.notes.length}}class SectionView{constructor(){this.layer,this.x,this.y,this.w,this.h,this.secName,this.uiSettings,this.headerView,this.boardView,this.isVisible=!1}init(e,t,i,s,o,n,a,l){this.layer=e,this.x=t+n,this.y=i+n,this.w=s-2*n,this.h=o-2*n,this.secName=a,this.uiSettings={styles:l.styles.section,properties:l.properties.section,getConfig:l.getConfig.section},this.headerView=new SectionHeaderView,this.headerView.init(this.layer,this.x,this.y,this.w,this.h,this.secName,l);var h=this.x,r=this.y+this.h*(this.uiSettings.properties.secNameRect.hPct/100),c=this.w*(this.uiSettings.properties.boardViewRect.wPct/100),d=this.h*(this.uiSettings.properties.boardViewRect.hPct/100);this.boardView=new SectionBoardView,this.boardView.init(this.layer,h,r,c,d,l)}relocateAt(e,t){this.makeVisible(!1),this.headerView.relocateAt(e,t);var i=e,s=t+this.h*(this.uiSettings.properties.secNameRect.hPct/100);this.boardView.relocateAt(i,s),this.x=e,this.y=t,this.makeVisible(!0)}applyTheme(e){this.uiSettings.styles=e.section,this.headerView.applyTheme(e),this.boardView.applyTheme(e)}makeVisible(e,t=!1,i=!1){this.headerView.makeVisible(e),this.boardView.makeVisible(e),this.isVisible=e}}class Workspace{constructor(){this.x,this.y,this.w,this.h,this.stage,this.defaultLayer,this.uiSettings,this.name,this.template,this.levels,this.noOfLevels,this.isVisible=!1}init(e,t,i,s){var o=this;o.x=0,o.y=0,o.w=.6*(window.screen.availWidth-(window.outerWidth-window.innerWidth)),o.h=window.screen.availHeight-(window.outerHeight-window.innerHeight)-($("header").outerHeight()+$("footer").outerHeight()),o.stage=new Konva.Stage({container:e,width:o.w,height:o.h}),o.defaultLayer=new Konva.Layer,o.stage.add(o.defaultLayer),o.uiSettings={styles:s.styles.workspace,properties:s.properties.workspace,getConfig:s.getConfig.workspace},o.name=t,o.template=i,o.levels=[],o.noOfLevels=0,o.template.levels.forEach(function(e,t){var i=o.x,n=o.y+t*(o.h*(s.properties.level.skeleton.hPct/100)),a=o.w*(s.properties.level.skeleton.wPct/100),l=o.h*(s.properties.level.skeleton.hPct/100),h=o.defaultLayer,r=o.name,c=o.uiSettings.properties[r][t];o.levels[t]=new Level,o.levels[t].init(h,i,n,a,l,r,e,s,c),++o.noOfLevels})}get(){var e=this.levels.map(function(e){return e.get()});return{name:this.name,levels:e}}set(e=[]){this.levels.map(function(t,i){return t.set(e[i])})}add(e,t=-1){var i=this.levels.find(t=>e.levelName===t.levelName);if(i){var s=i.view.boardView.sectionCollection.find(t=>e.secName===t.secName);if(s)return s.controller.addNote(e,t)}}update(e){var t=this.levels.find(t=>e.levelName===t.levelName);if(t){var i=t.view.boardView.sectionCollection.find(t=>e.secName===t.secName);if(i)return i.controller.updateNote(e)}}delete(e){var t=this.levels.find(t=>e.levelName===t.levelName);if(t){var i=t.view.boardView.sectionCollection.find(t=>e.secName===t.secName);if(i)return i.controller.deleteNote(e)}}unselect(){this.levels.forEach(function(e){e.view.boardView.sectionCollection.forEach(function(e){return e.controller.unselectNote()})})}getData(e){var t="",i=this.levels;switch(e){case"text/plain":t+=this.name+"\r\n",i.forEach(function(i){t+=i.getData(e)+"\r\n"});break;case"text/html":t+="<div class = 'workspace-container'>"+this.name+"</div>",i.forEach(function(i){t+=i.getData(e)})}return t}getTitle(){var e="";return e+="<td>",e+="<ul>",e+=this.name,this.levels.forEach(function(t){e+=t.getTitle()}),e+="</ul>",e+="</td>"}applyTheme(e){this.uiSettings.styles=e.workspace,this.levels.forEach(function(t){t.view.applyTheme(e)})}makeVisible(e){for(var t=0;t<this.noOfLevels;++t)this.levels[t].view.makeVisible(e);this.isVisible=e}}